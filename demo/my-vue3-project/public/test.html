<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div id="app"></div>
</body>
</html>
<script type="module">
    // import { reactive ,effect } from '/demo/my-vue3-project/node_modules/@vue/reactivity/dist/reactivity.esm-browser.js'
    const reactiveMap = new Map()
    const IS_REACTIVE = 'is_reactive'
    let activeEffect
    let lastEffect = undefined
    let targetMap = new WeakMap()
    function trigger(target,key,value,oldValue){
        const deps = targetMap.get(target)
        if(deps) {
            let dep = deps.get(key)
            if(dep) {
                for(let effect of dep.keys()) {
                    if(effect.scheduler) {
                        effect.scheduler()
                    }
                }
            }
          
        }
    }
    function trackEffect(effect,dep){
        dep.set(effect,effect._trackId)
        effect.deps[effect._depslength++] = dep

    }
    function createDep (cleanUp) {
        const dep = new Map()
        return dep
    }
    function track(target,key) {
        // console.log(target,key)
        if(activeEffect){
            let depsMap = targetMap.get(target)
            if(!depsMap){
                targetMap.set(target,depsMap = new Map())
            }
            let dep = depsMap.get(key)
            if(!dep) {
                depsMap.set(key,dep = createDep(()=> depsMap.delete(key)))
            }
            // 存依赖
            trackEffect(activeEffect,dep)
            console.log(targetMap)
        }
    }
    const mutableHandler = {
        get(target,key,receiver) {
            if(key === IS_REACTIVE) return true
            track(target,key)
            return Reflect.get(target,key,receiver) // 需要拿到依赖 拿得getter里的this.xxx的依赖
        },
        set(target,key,value,receiver){
            let oldValue = target[key]
            let result = Reflect.set(target,key,value,receiver) // 触发getter里的依赖
            if(oldValue != value) {
                trigger(target,key,value,oldValue)
            }
            return result
        }
    }
    function reactive(obj){
        // 不是obj 就返回原值
        if(typeof obj != 'object' && obj != null) return obj
        if(obj[IS_REACTIVE]) return obj
        if(reactiveMap.get(obj)) return reactiveMap.get(obj)
        const proxy = new Proxy(obj,mutableHandler)
        reactiveMap.set(obj,proxy)
        return proxy
    }
    

     function effect(fn,options) {
        const _effect = new ActiveEffect(fn,()=>{
            _effect.run()
        })
        _effect.run()
        return _effect
     }

     class ActiveEffect {
        active = true
        _trackId = 0
        deps = []
        _depslength = 0
        constructor(fn,scheduler) {
            this.fn = fn
            this.scheduler = scheduler
        }
        run() {
            if(!this.active) return this.fn()
            try {
                lastEffect = activeEffect
                activeEffect = this
                return this.fn()
            } finally {
                activeEffect = lastEffect
            }
        }
     }
    var obj = {
        name: '小明',
        age: 12,
        get live() {
            return this.age + '我只了'
        }
    }
    var obj2 = {
        address: '好吧'
    }
    const test1 = reactive(obj)
    // console.log(test1.live)
    effect(()=>{
        app.innerHTML = `我的名字叫${test1.name},我的年龄是${test1.age}`
        // effect(()=>{
        //     console.log('我真的好难啊',test1.name)
        // })
        // console.log(test1.age)
    })
    // setInterval(()=>{
    //     
    // },1000)
    setTimeout(()=>{
        test1.age++
    },1000)
    // test1.age++
</script>